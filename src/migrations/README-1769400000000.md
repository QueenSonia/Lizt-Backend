# Migration: UpdateOfferLettersTableForPayments

**Migration File:** `1769400000000-UpdateOfferLettersTableForPayments.ts`

**Timestamp:** 1769400000000

**Status:** âœ… Successfully executed

## Overview

This migration updates the `offer_letters` table to support the payment tracking system for the Offer Letter Payment feature. It adds columns for tracking payment amounts, payment status, and new offer letter statuses related to payment outcomes.

## Changes Made

### 1. New Columns Added

#### 1.3.1: Payment Amount Columns

- **`total_amount`** (decimal 12,2, nullable initially)
  - Stores the total amount due for the offer letter
  - Calculated from: rent + service_charge + caution_deposit + legal_fee + agency_fee
- **`amount_paid`** (decimal 12,2, NOT NULL, default 0)
  - Tracks the total amount paid by the tenant
  - Sum of all successful payments
- **`outstanding_balance`** (decimal 12,2, nullable initially)
  - Remaining amount to be paid
  - Calculated as: total_amount - amount_paid

#### 1.3.2: Payment Status Column

- **`payment_status`** (enum, NOT NULL, default 'unpaid')
  - Enum values: 'unpaid', 'partial', 'fully_paid'
  - Tracks the overall payment status of the offer letter

#### 1.3.3: Selection Timestamp

- **`selected_at`** (timestamp, nullable)
  - Records when this offer letter was selected (tenant won the property)
  - Set when a tenant completes 100% payment first

### 2. New Enum Values Added

#### 1.3.4: Status Enum Extensions

Added three new values to the `offer_letters_status_enum`:

- **`selected`**: Offer letter was selected (tenant won and paid 100%)
- **`rejected_by_payment`**: Offer letter was rejected because another tenant paid first
- **`payment_held_race_condition`**: Tenant paid 100% but property was already taken (race condition)

### 3. Indexes Created

#### 1.3.5: Performance Indexes

- **`IDX_offer_letters_payment_status`**: Index on `payment_status` column
  - Optimizes queries filtering by payment status
- **`IDX_offer_letters_property_payment`**: Composite index on `(property_id, payment_status, status)`
  - Optimizes queries for finding offers with payments for a specific property
  - Critical for race condition prevention and payment processing

### 4. Data Migration

The migration includes a data update query that:

- Calculates `total_amount` for existing offer letters
- Sets `outstanding_balance` equal to `total_amount` for existing records
- Handles edge cases where fee fields might be NULL or non-numeric strings
- Only updates records where `total_amount` IS NULL (existing records)

## Rollback Support

The migration includes a `down()` method that:

- Drops the two new indexes
- Drops the four new columns
- Drops the `offer_letters_payment_status_enum` type
- Note: PostgreSQL doesn't support removing enum values, so the new status values will remain but won't cause issues

## Verification

The migration was successfully executed with the following results:

- All columns added successfully
- Payment status enum created
- Status enum values added
- Indexes created
- Existing records updated with calculated totals
- Migration recorded in the migrations table

## Related Files

- **Design Document:** `.kiro/specs/offer-letter-payments/design.md`
- **Requirements:** `.kiro/specs/offer-letter-payments/requirements.md`
- **Tasks:** `.kiro/specs/offer-letter-payments/tasks.md` (Task 1.3)

## Next Steps

After this migration:

1. Update the OfferLetter entity to include the new columns
2. Update DTOs to handle the new fields
3. Implement payment tracking logic in the service layer
4. Create payment-related endpoints

## Testing

To verify the migration:

```bash
# Check the columns exist
npm run typeorm -- query "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'offer_letters' AND column_name IN ('total_amount', 'amount_paid', 'outstanding_balance', 'payment_status', 'selected_at');" -d src/data-source.ts

# Check the indexes exist
npm run typeorm -- query "SELECT indexname FROM pg_indexes WHERE tablename = 'offer_letters' AND indexname LIKE '%payment%';" -d src/data-source.ts

# Check the enum values
npm run typeorm -- query "SELECT enumlabel FROM pg_enum WHERE enumtypid = (SELECT oid FROM pg_type WHERE typname = 'offer_letters_status_enum');" -d src/data-source.ts
```

## Notes

- The migration is idempotent for enum value additions (checks if value exists before adding)
- Existing offer letters will have their totals calculated automatically
- The `agency_fee` field is handled as both string and decimal for backward compatibility
- All decimal fields use precision 12 and scale 2 (supports amounts up to 9,999,999,999.99)
